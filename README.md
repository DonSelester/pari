# "Paribet"
It`s one of my student django projects. Site created for bets on sports, in this project I've used PostgreSQL 9.5.<br>
This site provides you with opportunities such as:
- Register, login;
![Login_page](https://lh3.googleusercontent.com/Q8C4vJkz6yyohyRPE_dEQqxU5wvDc1KSgZMdnbfKQLTcycf5PyT14urNKGThUKsMvLEA4Scr_ppqvO-XgOWSrG1Bzk15DsxOVBIDU8Qdkbd62wBbcajCy-LiePolSvXtJmmC3Aj5cfcVkHSBd2PsZvq8eZm2vnUWkAPqOTg7vK_fAy_LRbF6olCjO46o9Gg6YSbuzv4wUsP89SWwvY04PF8zkBlqsF2XfDqND11Yvxcw-4G_eDLiYG5sGX74EcW-ghOUl87DYWMGI9mGvPrdl_JiuQZma0npF_9h27OddurmWvwXEAPBVnv5XiDrbRaqWUW1qnVOtM2j3uOeLD05-cSIOjKEWnTvW7rH7Nhc0Q1Mq9USL18rAKCYWe7SL9G-afRlxa0mxWZo3jk_z4rOYtrpJmUyyCRRIHHhEO7or0N1eTBUNBCUoFfejdglf9zmpIbT4Eyz8BeTZxXFkuNN8Q_IQotUkGOhS8uz1EKwf5udhGyJnJt2fv3e9njO_mpFF18XZhf3YRSsF8H-OKwUkauQEf02TV8zVf6AnhwNzN2bbNmcCnANmO1a8uGCZF0uv6tszh7xXo7gm8p5Oha8e6j4hjP2qzklQOnd0qg=w1280-h534-no)
- Match viewing;
![Index_page](https://lh3.googleusercontent.com/v-A_xBTBQNcXOCNHvjQQ1yJWQ-Ih7D0NmjZ9-1Ef5CB3iZaDyvtZfRpdDK2EJJ3QbV-t7xs1uYvDduS194fwagB_su3R5Jv6MiAJYMHrOJjD0076E4Yjw4JUvaR2LAueOOsJRmAcR4RERtCvJtxb2zz2YSHraoBim9gVEL7chxSFDysg2NC04QG3-xuHU0yMzg3hTXvBMratyv9yYSiLVmrTQgGtwU9xYQ09fXJbBtCgvy7kTS8stpVTgvrF8jFzQ03FcqqR31xVHkcYTfA-z-Bw6V7Nf1lpY5vgFBaP1If7isZZt4_YeSKJgL1doETSgnj3blo4ABeSdlaQ90XKi2wpbEtXArN-IAKIn9nFML-yZ7rDMvI3sFqC-eNlVtdNME4OoqYCjTkn20jGFxegCs5YQAWy_f1A8nyk34XU-Bwf5ANFo7njAJpxYYJe7OIGgxSf3S8CtHi8U1ifeDespt7m51qO3Nt9KcmmOM9tANkxLV9XRROSLeZEmjlhTomXZ022iLhB3RgsGZOrQyZycaKYo_r2wzgqtmCpNQDw7HQ1CVNdiSGa3lTKkE5mmY5acZWDuTXfJOAHzFk09TXFmQyBkTnkb-ODpZgH7Q4=w1280-h651-no)
- Filter by kind of sport or leagues;
- Place a bet;
![Bet_page](https://lh3.googleusercontent.com/YAXykrunoROv58HUa1qCObSJ0c3qmWKefUoj0fFjoh-cdv4FbXmiPumDMhxlfwuikwT0iwr9NyDp2cu5vA-bJDrDt14C1CZB8-aTa5hTiIgFhv2P6xu6uhI09zfRUIj8T8MzWYJpf38LeS8pOdKU61VNdSwgkEUBcbgQw91lemwuMuemszp-r8ntvqSo19nNfzud3s-gkoN-UGR3SRwjNGeicy-uT4x0pvJaF80kStmxiwuc4Z8qT-dyvTjV2v0qcnzDc_D8PQb1Xbz9htu-glZHVXvguRhXJz0iws2gnCUued4oVhbBPUq7USWlnWIgCRfWdWeVs8fqb9c4Zeoykz88wsIfa00hoEh6y84kUQOY35PeVVuyymU03jy80AHHJ8WHcy3L9ZBI-dwozvq8EOeAjOx2m3XTn6L_ekYG4rcT0yGq_DgR40nD437BPPEHmuBwiQWI6otXsuHdTJBibBo3dMaXMx3KjLZRx5N_tIqSMdhT-pfm1dtju-S0UKjy3KYySSW0lRYSkFGGgL0nxd40ePBNRONulanextqx0mjWpO8Q0jrhO_XI6XJw7inmA9cuuxndKCGtv-v19i2otGWnpYJ-Z7lj2IVt934=w1280-h652-no)
![after_bet](https://lh3.googleusercontent.com/1qUCXARmmlU0I4UgV0LuAluKCvzg_76Zncca8IgnsuhPHz_3lnNg6WVj_5EFZcF24ehb8M06JW7a8jjCb-qWx9yU5upWNDAdK5CPDDVYz4YZaSA32IQcn_lbmhb2XG3NQYlQKH-CFEp1x68s3UEdoXj-gaWONBVq-oyxiJVuvLjbiV5EpGSUVdUVOjT0hGXX3VKHWrZAfcYVq0n81s9MPzePo5uPEgM3b_pOz1-k9LsDS5VP2Z-nIeHMgsoq_E4bNHfeImeenisG0ZGs7SLFof8WD1rZkBxJf9ecnB8B5s1igrG6ADCeDZB1KETvJmzbjed6G1Fmlp3m0HtdBr40y8qbvFMuD8rkLiBnT7VeghwHcSDgUdQqiyAuqfqJVE7iikerQAL6alSTAfQTWDJFLqbPffVHzHjaviZZVuR2YNesUBmR4kcOj1M6zUIPcnLKvg8fBX7pq_Iug90PudBlDJTR8v0lakmGmcdjMNSu44UTxjrpIxkSAdWF1sIHBXfPILCOt2sgPid_Iayz6dIqHn3zxOOQ3-xuGt959f0X-yIi_QEjvtWRj2l2bcQONI3BLuefNufQipO2ZGXy1eWJZqTJlpUUfapb34sO0KQ=w1280-h650-no)
- Account balance replenishment and view operations;
![balance_page](https://lh3.googleusercontent.com/i_X65j61MWaP2h3PWHy5EA-67oS9ZNn-eDRgtNJVOdvsSqHu8iB7rm_mRrjVyvT7A6tlzCVnQbLitUlEWfeYivC13k4ZH4qDZ46jNAEbBw8MEp_hKHs_R7qxIYSEfV4p-LLdOKHe3RYG0WTVwZXMIhbRtPdPRnK0RLxnPoddh3fmopdny4_xGzQYeE1bfX-FtXwxmHkk27-9A1bbunOTJ_TeRAyu1HuUMzLVLwNMGU_nExbrpE5u03aYSKlfP9KECpsVjtx2VUgEsx9utfOb19B8hg_Cw8sOzIFhbu8txv-F4n4uyYbJ2dU0wzoLc7PwBBheOLWVnZR8P3YTHfhl_IQAxG14CNTTtbOmmY3yHiN6nHrHYV1IIu-IpV4bG6F52tMpTfjo9QuvjcwN3pRRabgTGQYJv6iSh7Ac1omtUaER9xpzBfmvBBcsJo2Fyofvhl1sLDPIoUEam0NDnp3fIS7R7S1R-58fwYg3gtH5yh-N4Ydx-ngk55EnpkVWEfqAS6w5FDtBxrt-6rRpcpWxfauFCToLHecUQ3tLuxPKs77nBNb_1hKukbBMSI2_z-l1W9_xs1OgYs1YMv78Dzjxm-Zl6GGiM7YEwtgZddc=w1280-h650-no)
<br>
Percents and coefficients of any match, calculating in the DB View and it also has a few tgiggers, code below:

-----------------------------------------------------------------
View to calculate percents and coefficients of matches
-----------------------------------------------------------------
Create view match_koef as
(<br>
with<br>
asd as(select distinct match_id, bet_team_id, count(bet_team_id) over(partition by match_id, bet_team_id) c from bet_bet),<br>
dsa as (SELECT match_id, bet_team_id, c , sum(c) over(partition by match_id) s from asd),<br>
sda as (SELECT match_id, bet_team_id, (c/s)*100 perc from dsa)<br>
SELECT match_id, bet_team_id, round(perc,1) perc, round(100/perc,2) koef from sda)

-----------------------------------------------------------------
Trigger to give money to everyone who betted on the winners team
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION match_rewards_F() RETURNS TRIGGER<br>
AS $$
DECLARE<br>
win_koef match_koef.koef%TYPE;
m_id bet_bet.match_id%TYPE;
b_team_id bet_bet.bet_team_id%TYPE;
acc_id bet_bet.account_number_id%TYPE;
b_amount bet_bet.bet_amount%TYPE;
BEGIN<br>

Select koef into win_koef from match_koef where match_koef.match_id = New.match_id and match_koef.bet_team_id = New.team_id;<br>

FOR m_id, b_team_id, acc_id, b_amount in SELECT bet_bet.match_id, bet_team_id, account_number_id, bet_amount FROM bet_bet where bet_bet.match_id = New.match_id and bet_bet.bet_team_id = New.team_id<br>
	LOOP <br>
	UPDATE bet_player SET balance = balance + (b_amount*win_koef) WHERE account_number_id = acc_id;<br>
	INSERT INTO bet_operation (account_number_id, date, card, operation_type, transaction_amount) VALUES (acc_id, now(), ('Выиграш по матчу №' || m_id), 'Зачисление', (b_amount*win_koef));<br>
	
END LOOP;<br>
RETURN NEW;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER match_rewards
AFTER INSERT ON bet_winner<br>
FOR EACH ROW EXECUTE PROCEDURE match_rewards_F();

-----------------------------------------------------------------
Trigger to give money to everyone who betted on the draw
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION match_draw_rewards_F() RETURNS TRIGGER<br>
AS $$
DECLARE<br>
draw_koef match_koef.koef%TYPE;
m_id bet_bet.match_id%TYPE;
b_team_id bet_bet.bet_team_id%TYPE;
acc_id bet_bet.account_number_id%TYPE;
b_amount bet_bet.bet_amount%TYPE;
BEGIN<br>

Select koef into draw_koef from match_koef where match_koef.match_id = New.match_id and match_koef.bet_team_id = 7;<br>

FOR m_id, b_team_id, acc_id, b_amount in SELECT bet_bet.match_id, bet_team_id, account_number_id, bet_amount FROM bet_bet where bet_bet.match_id = New.match_id and bet_bet.bet_team_id = 7<br>
	LOOP <br>
	UPDATE bet_player SET balance = balance + (b_amount*draw_koef) WHERE account_number_id = acc_id;<br>
	INSERT INTO bet_operation (account_number_id, date, card, operation_type, transaction_amount) VALUES (acc_id, now(), ('Выиграш по матчу №' || m_id), 'Зачисление', (b_amount*draw_koef));<br>
END LOOP;<br>
RETURN NEW;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER match_draw_rewards
AFTER INSERT ON bet_draw<br>
FOR EACH ROW EXECUTE PROCEDURE match_draw_rewards_F();

-----------------------------------------------------------------
Trigger to check if match already has an result
-----------------------------------------------------------------
CREATE OR REPLACE FUNCTION match_result_F() RETURNS TRIGGER<br>
AS $$
BEGIN<br>

IF (EXISTS(select match_id from bet_draw where bet_draw.match_id = NEW.match_id) OR EXISTS(select match_id from bet_winner where bet_winner.match_id = NEW.match_id)) THEN<br>
	RAISE EXCEPTION 'This match already have result!';<br>
ELSE RETURN NEW;<br>
END IF;<br>
END;<br>
$$ LANGUAGE plpgSQL;<br>
CREATE TRIGGER match_result_d
BEFORE INSERT ON bet_draw<br>
FOR EACH ROW EXECUTE PROCEDURE match_result_F();<br>
CREATE TRIGGER match_result_w
BEFORE INSERT ON bet_winner<br>
FOR EACH ROW EXECUTE PROCEDURE match_result_F();
